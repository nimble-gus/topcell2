// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// ============================================
// CATÁLOGO Y PRODUCTOS
// ============================================

model Marca {
  id                Int                @id @default(autoincrement())
  nombre            String             @unique
  logoUrl           String?            // URL del logo en Cloudinary
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  telefonosNuevos   TelefonoNuevo[]
  telefonosSeminuevos TelefonoSeminuevo[]
  accesorios        Accesorio[]
}

model Color {
  id                Int                @id @default(autoincrement())
  color             String             @unique
  createdAt         DateTime           @default(now())
  
  telefonosNuevos   TelefonoNuevoVariante[]
  telefonosSeminuevos TelefonoSeminuevoVariante[]
  accesorios        AccesorioColor[]
}

// Tabla de variantes: combina Color + Almacenamiento (ROM) + Stock
// Permite tener múltiples variantes del mismo producto (ej: iPhone 17 Negro 128GB, iPhone 17 Negro 256GB)
model TelefonoNuevoVariante {
  id                Int                @id @default(autoincrement())
  telefonoNuevoId   Int
  colorId           Int
  rom               String             // Almacenamiento: "128GB", "256GB", "512GB", etc.
  stock             Int                @default(0)
  createdAt         DateTime           @default(now())
  
  telefonoNuevo     TelefonoNuevo      @relation(fields: [telefonoNuevoId], references: [id], onDelete: Cascade)
  color             Color              @relation(fields: [colorId], references: [id], onDelete: Cascade)
  
  @@unique([telefonoNuevoId, colorId, rom]) // Una variante única por combinación de producto, color y ROM
  @@index([telefonoNuevoId])
  @@index([colorId])
}

// Tabla de variantes para teléfonos seminuevos: combina Color + Almacenamiento (ROM) + Estado + Batería + Ciclos + Precio + Stock
model TelefonoSeminuevoVariante {
  id                Int                @id @default(autoincrement())
  telefonoSeminuevoId Int
  colorId           Int
  rom               String             // Almacenamiento: "128GB", "256GB", "512GB", etc.
  estado            Int                @default(10) // Estado del teléfono (1-10, donde 10 es "En perfecto estado")
  precio            Decimal            @db.Decimal(10, 2) // Precio específico de esta variante
  porcentajeBateria Int?               // Porcentaje de batería (obligatorio si es iPhone)
  ciclosCarga       Int?               // Ciclos de carga (opcional, solo si es iPhone)
  stock             Int                @default(0)
  createdAt         DateTime           @default(now())
  
  telefonoSeminuevo TelefonoSeminuevo  @relation(fields: [telefonoSeminuevoId], references: [id], onDelete: Cascade)
  color             Color              @relation(fields: [colorId], references: [id], onDelete: Cascade)
  
  @@unique([telefonoSeminuevoId, colorId, rom, estado, porcentajeBateria, ciclosCarga]) // Variante única por combinación completa
  @@index([telefonoSeminuevoId])
  @@index([colorId])
}

// Tabla intermedia para relación muchos a muchos: Accesorio - Color
// Ahora incluye stock por color para manejar variantes
model AccesorioColor {
  id                Int                @id @default(autoincrement())
  accesorioId       Int
  colorId           Int
  stock             Int                @default(0) // Stock específico para este color
  createdAt         DateTime           @default(now())
  
  accesorio         Accesorio          @relation(fields: [accesorioId], references: [id], onDelete: Cascade)
  color             Color              @relation(fields: [colorId], references: [id], onDelete: Cascade)
  
  @@unique([accesorioId, colorId])
  @@index([accesorioId])
  @@index([colorId])
}

model TelefonoNuevo {
  id                Int                @id @default(autoincrement())
  marcaId           Int
  modelo            String
  precio            Decimal            @db.Decimal(10, 2)
  procesador        String
  ram               String             // Ej: "8GB", "12GB"
  rom               String             // Ej: "128GB", "256GB" - Este campo ahora es solo para referencia, las variantes tienen su propio ROM
  mpxlsCamara       String             // Ej: "48MP", "108MP"
  tamanoPantalla    String             // Ej: "6.1 pulgadas"
  tipoEntrada       String             // Ej: "USB-C", "Lightning"
  stock             Int                @default(0) // Stock total (calculado desde colores)
  descripcion       String?            @db.Text
  activo            Boolean            @default(true)
  featured          Boolean            @default(false) // Producto destacado para FeaturedSection
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  marca             Marca              @relation(fields: [marcaId], references: [id], onDelete: Restrict)
  variantes         TelefonoNuevoVariante[]
  imagenes          ImagenProducto[]
  itemsOrden        ItemOrden[]
  
  @@index([marcaId])
  @@index([activo])
  @@index([featured])
}

model TelefonoSeminuevo {
  id                Int                @id @default(autoincrement())
  marcaId           Int
  modelo            String
  precio            Decimal            @db.Decimal(10, 2) // Precio base (las variantes pueden tener su propio precio)
  procesador        String
  ram               String
  rom               String             // Solo para referencia, las variantes tienen su propio ROM
  mpxlsCamara       String
  tamanoPantalla    String
  tipoEntrada       String
  stock             Int                @default(0) // Stock total (calculado desde variantes)
  descripcion       String?            @db.Text
  activo            Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  marca             Marca              @relation(fields: [marcaId], references: [id], onDelete: Restrict)
  variantes         TelefonoSeminuevoVariante[]
  imagenes          ImagenProducto[]
  itemsOrden        ItemOrden[]
  
  @@index([marcaId])
  @@index([activo])
}

model Accesorio {
  id                Int                @id @default(autoincrement())
  marcaId           Int
  modelo            String             // Modelo del accesorio
  precio            Decimal            @db.Decimal(10, 2)
  descripcion       String             @db.Text
  stock             Int                @default(0)
  activo            Boolean            @default(true)
  featured          Boolean            @default(false) // Producto destacado para FeaturedSection
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  marca             Marca              @relation(fields: [marcaId], references: [id], onDelete: Restrict)
  colores           AccesorioColor[]
  imagenes          ImagenProducto[]
  itemsOrden        ItemOrden[]
  
  @@index([marcaId])
  @@index([activo])
  @@index([featured])
}

model ImagenProducto {
  id                Int                @id @default(autoincrement())
  url               String             // URL de Cloudinary
  tipo              String             @default("galeria") // "principal", "galeria"
  telefonoNuevoId   Int?
  telefonoSeminuevoId Int?
  accesorioId       Int?
  orden             Int                @default(0) // Para ordenar imágenes
  createdAt         DateTime           @default(now())
  
  telefonoNuevo     TelefonoNuevo?     @relation(fields: [telefonoNuevoId], references: [id], onDelete: Cascade)
  telefonoSeminuevo TelefonoSeminuevo? @relation(fields: [telefonoSeminuevoId], references: [id], onDelete: Cascade)
  accesorio         Accesorio?         @relation(fields: [accesorioId], references: [id], onDelete: Cascade)
  
  @@index([telefonoNuevoId])
  @@index([telefonoSeminuevoId])
  @@index([accesorioId])
}

// ============================================
// CONTENIDO DE LA TIENDA
// ============================================

model ContenidoTienda {
  id                Int                @id @default(autoincrement())
  tipo              String             // "hero", "logo", "banner", "publicidad"
  url               String             // URL de Cloudinary
  descripcion       String?            @db.Text
  activo            Boolean            @default(true)
  orden             Int                @default(0) // Para ordenar contenido
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  @@index([tipo])
  @@index([activo])
}

// ============================================
// USUARIOS Y AUTENTICACIÓN
// ============================================

model Usuario {
  id                Int                @id @default(autoincrement())
  email             String             @unique
  nombre            String
  apellido          String?
  telefono          String?
  direccion         String?            @db.Text
  ciudad            String?
  codigoPostal      String?
  activo            Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  ordenes           Orden[]
  
  @@index([email])
}

model UsuarioAdmin {
  id                Int                @id @default(autoincrement())
  email             String             @unique
  nombre            String
  passwordHash      String             // Hash de la contraseña
  rol               String             @default("admin") // "admin", "superadmin"
  activo            Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLogin         DateTime?
  
  @@index([email])
  @@index([activo])
}

// ============================================
// ECOMMERCE - ÓRDENES
// ============================================

enum EstadoOrden {
  PENDIENTE
  PROCESANDO
  ENVIADO
  ENTREGADO
  CANCELADO
}

model Orden {
  id                Int                @id @default(autoincrement())
  usuarioId        Int
  numeroOrden      String             @unique // Número único de orden
  estado            EstadoOrden        @default(PENDIENTE)
  subtotal          Decimal            @db.Decimal(10, 2)
  impuestos         Decimal            @default(0) @db.Decimal(10, 2)
  envio             Decimal            @default(0) @db.Decimal(10, 2)
  total             Decimal            @db.Decimal(10, 2)
  direccionEnvio   String             @db.Text
  ciudadEnvio       String?
  codigoPostalEnvio String?
  notas             String?            @db.Text
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  usuario           Usuario            @relation(fields: [usuarioId], references: [id], onDelete: Restrict)
  items             ItemOrden[]
  
  @@index([usuarioId])
  @@index([estado])
  @@index([numeroOrden])
  @@index([createdAt])
}

enum TipoProducto {
  TELEFONO_NUEVO
  TELEFONO_SEMINUEVO
  ACCESORIO
}

model ItemOrden {
  id                Int                @id @default(autoincrement())
  ordenId           Int
  tipoProducto      TipoProducto
  telefonoNuevoId    Int?
  telefonoSeminuevoId Int?
  accesorioId       Int?
  cantidad          Int
  precioUnitario    Decimal            @db.Decimal(10, 2) // Precio al momento de la compra
  subtotal          Decimal            @db.Decimal(10, 2)
  createdAt         DateTime           @default(now())
  
  orden             Orden              @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  telefonoNuevo     TelefonoNuevo?     @relation(fields: [telefonoNuevoId], references: [id], onDelete: Restrict)
  telefonoSeminuevo TelefonoSeminuevo? @relation(fields: [telefonoSeminuevoId], references: [id], onDelete: Restrict)
  accesorio         Accesorio?         @relation(fields: [accesorioId], references: [id], onDelete: Restrict)
  
  @@index([ordenId])
  @@index([tipoProducto])
}

